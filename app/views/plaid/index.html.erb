<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const createLinkToken = async () => {
        const res = await fetch("/plaid/create_link_token", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
          }
        });
        const data = await res.json();
        console.log(JSON.stringify(data));
        const linkToken = data.link_token;
        localStorage.setItem("link_token", linkToken); // for Oauth
        return linkToken;
      };

      // Initialize Link
        const handler = Plaid.create({
        token: await createLinkToken(),
        onSuccess: async (publicToken, metadata) => {
            await fetch("/plaid/exchange_public_token", {
            method: "POST",
            body: JSON.stringify({ public_token: publicToken }),
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
            },
            });
            // await getBalance();
        },
        onEvent: (eventName, metadata) => {
            console.log("Event:", eventName);
            console.log("Metadata:", metadata);
        },
        onExit: (error, metadata) => {
            console.log(error, metadata);
        },
        });

        // Start Link when button is clicked
        const linkAccountButton = document.getElementById("link-account");
            linkAccountButton.addEventListener("click", (event) => {
             handler.open();
        });

    })
</script>

<button type="button" id="link-account">
    <strong>Link account</strong>
</button>

<pre id="response"></pre>